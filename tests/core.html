<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>Mapstraction V3 Core Tests</title>
	<script type="text/javascript" src="mxn-harness.js"></script>

	<link rel="stylesheet" type="text/css" media="all" href="css/core.css" />
	<meta http-equiv="X-UA-Compatible" content="IE=7; IE=EmulateIE9" />
		
	<script type="text/javascript">
    var googlev3_key = 'AIzaSyDW21lnrSsBk4OyHUDmBQ7su9di3yMaO7I';
    var nokia_app_id = 'FbgYuugcrj8Taq6JjmUK';
    var nokia_auth_token = 'Yy2i2n98kaWj69qysOmcYg';
    var microsoftv7_key = 'AlneHdcKOFDot4FjwyuLH8ZSUIz5rv_X22vULKa7H5ia0JnsxiykdO8y-dgLQMU6';
    var openspace_key = 'CEEFBE51588492CBE0405F0ACA6010B1';
    var mapquest_key = 'Fmjtd%7Cluub29uy25%2Crs%3Do5-96zl9y';
    var yandexv1_key = 'AMVH-VABAAAAEdVkcQIAOS-fmBYJfLFV-YDg7ZCPjwVQycUAAAAAAAAAAADwTFcvgPirz7OV75IX_Gsopsw7jA==';
	
	var provider;
	var autoRun = 'false';

	(function() {
		var providerMatch = location.search.match( /provider=([^&]*)/ );
		var autorunMatch = location.search.match( /auto=([^&]*)/ );

		if (providerMatch) {
			provider = providerMatch[1];
		}
		
		else {
			provider = 'google';
		}

		if (autorunMatch) {
			autoRun = autorunMatch[1];
			if (autoRun !== 'true') {
				autoRun = 'false';
			}
		}
	
		switch (provider) {
			case 'nokia':
				new_provider = 'google';
				break;
			default:
				new_provider = 'nokia';
				break;
		}

		var providers = 'google,here';
		if (provider != 'google' && provider != 'here') {
			providers = provider + ',' + providers;
		}
		document.write('<script type="text/javascript" src="../source/mxn.js?(' + providers + ',[autoload])"><\/script>');
	})();

	var events = {
		LOAD: {name: 'load', value: false},
		//CLICK: {name: 'click', value: false},
		END_PAN: {name: 'endPan', value: false},
		CHANGE_ZOOM: {name: 'changeZoom', value: false},
		MARKER_ADDED: {name: 'markerAdded', value: false},
		MARKER_INFOBUBBLE_OPENED: {name: 'InfoBubbleOpened', value: false}, 
		MARKER_INFOBUBBLE_CLOSED: {name: 'InfoBubbleClosed', value: false},
		MARKER_REMOVED: {name: 'markerRemoved', value: false},
		POLYLINE_ADDED: {name: 'polylineAdded', value: false},
		POLYLINE_REMOVED: {name: 'polylineRemoved', value: false}
	};
	
	function logInfo(msg) {
		logMessage ('info', msg);
	}
	
	function logEvent(msg) {
		logMessage ('events', msg);
	}

	function logMessage(element, msg) {
		var	display = document.getElementById(element);
		
		display.innerHTML += msg + '<br />';
		display.scrollTop = display.scrollHeight - display.clientHeight;
		return false;
	}
	
	function arrayContains(a, obj) {
	    var i = a.length;
	    while (i--) {
	       if (a[i] === obj) {
	           return true;
	       }
	    }
	    return false;
	}
	
	function arrayIndex(arr, obj) {
		var i = arr.length;
		while (i--) {
			if (arr[i] === obj) {
				return i
			}
		}
		
		return false;
	}
	
	var m;
	window.onload = function() {
		var actionElm = document.getElementById('actions');
		var infoElm = document.getElementById('info');		
		var eventsElm = document.getElementById('events');
		var providerElm = document.getElementById('provider');
		
		providerElm.innerHTML = provider;

	    //TODO: move this to utils?
		var supportedProviders = [];
		for (var prov in mxn.Providers) {
		    if (mxn.Providers[prov].state === "active" && mxn.Providers[prov].type === "master") {
		        supportedProviders.push(prov.valueOf());
		    }
		}

		var list = document.getElementById("providers");
		var auto = document.createElement("li");
		auto.innerHTML = '<a href="core.html?provider=' + supportedProviders[0] + '&auto=true">Auto-run all providers</a>';
		list.appendChild(auto);

		for (var prov in supportedProviders) {
		    //p.provder-selection
		    var newli = document.createElement("li");
		    var newlink = document.createElement("a");
            var newname = document.createTextNode(supportedProviders[prov]);
            newli.appendChild(newlink);
            newlink.appendChild(newname);
            newlink.href = "core.html?provider=" + supportedProviders[prov];
		    list.appendChild(newli);
		}
		
		m = new mxn.Mapstraction('map', provider);

		// Ensure load event is handled before a subsequent call to setCenterAndZoom so
		// that the CloudMade load event fires correctly (it appears to trap the first
		// call to setCenter after map load, not the actual loading itself)

		m.load.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Map loaded for provider: ' + oEvtSource.api);
			events.LOAD.value = true;
		});

		// So far this is only necessary for leaflet.
		m.setCenterAndZoom(new mxn.LatLonPoint(37.4419, -122.1419), 10);

		m.endPan.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			var center = oEvtSource.getCenter();
			logEvent('Map pan: ' + Dump(center));
			events.END_PAN.value = true;
		});
		
		m.changeZoom.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			var zoom = oEvtSource.getZoom();
			logEvent('Change zoom: ' + zoom.toString());
			events.CHANGE_ZOOM.value = true;
		});
		
		m.markerAdded.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker added: ' + oEvtArgs.marker.labelText);
			events.MARKER_ADDED.value = true;
		});
		
		m.markerRemoved.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker removed: ' + oEvtArgs.marker.labelText);
			events.MARKER_REMOVED.value = true;
		});

		m.polylineAdded.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Polyline added');
			events.POLYLINE_ADDED.value = true;
		});

		m.polylineRemoved.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Polyline removed');
			events.POLYLINE_REMOVED.value = true;
		});

		m.click.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Map clicked: ' + Dump(oEvtArgs.location));
		});
		
		var markerEventHandler = function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker event: ' + sEvtName + ' - ' + oEvtSource.labelText);
			
			switch (sEvtName) {
				case 'openInfoBubble':
					events.MARKER_INFOBUBBLE_OPENED.value = true;
				break;
				case 'closeInfoBubble':
					events.MARKER_INFOBUBBLE_CLOSED.value = true;
				break;

				default:
					break;
			}
		};
				
		var ops = [
			{
				desc: 'Get API version',
				action: function() {
					var version = m.getVersion();
					logInfo('API Version "' + version + '" for "' + provider + '" loaded');
				}
			},
			{
				desc: 'Center map',
				action: function(){
					var point;
					var zoom;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(52.6959, 1.6846);
							zoom = 12;
							break;
						default:
							point = new mxn.LatLonPoint(37.4419, -122.1419);
							zoom = 9;
							break;
					}
					m.setCenterAndZoom(point, zoom);
				} 
			},		 
			{
				desc: 'Pan map',
				action: function(){
					var point;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(51.4269, -0.3339);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -122.0419);
							break;
					}
					
					m.setCenter(point, {pan: true});
				}
			},
			{
				desc: 'Get info',
				action: function(){
					logInfo('Info');
					var bb = m.getBounds();
					logInfo('Bounds:<br/>' + Dump(bb));
					var ll = m.getCenter();
					logInfo('Center: ' + Dump(ll));
					logInfo('Map type: ' + m.getMapType());
					logInfo('Zoom: ' + m.getZoom());
				}
			},
			{
				desc: 'Set zoom',
				action: function(){
					var zoom;
					switch (provider) {
						case 'openspacev4':
							zoom = 9;
							break;
						default:
							zoom = 8;
							break;
					}
					m.setZoom(zoom);
				}
			},
			{
				desc: 'Add marker',
				action: function() {
					var point;
					var mkr;
					var label;
					switch (provider) {
						case 'openspacev4':
							label = 'Twickenham Rugby Stadium';
							point = new mxn.LatLonPoint(51.45599, -0.34146);
							break;
							
						default:
							label = 'SFO International Terminal';
							point = new mxn.LatLonPoint(37.6156, -122.3891);
							break;
					}
					mkr = new mxn.Marker(point);
					mkr.setLabel(label);
					m.setCenter(point);
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Remove marker',
				action: function() {
					m.removeMarker(m.markers[0]);
				}
			},
			{
				desc: 'Add shape',
				action: function() {
					var shp;
					switch (provider) {
						case 'openspacev4':
						shp = new mxn.Polyline([
							new mxn.LatLonPoint(51.564, -0.534),
							new mxn.LatLonPoint(51.690, -0.231),
							new mxn.LatLonPoint(51.596, 0.040),
							new mxn.LatLonPoint(51.390, 0.191),
							new mxn.LatLonPoint(51.264, -0.131),
							new mxn.LatLonPoint(51.311, -0.429),
							new mxn.LatLonPoint(51.430, -0.533),
							new mxn.LatLonPoint(51.564, -0.534)
						]);
							break;
						default:
							shp = new mxn.Polyline([
								new mxn.LatLonPoint(37.805, -122.480),
								new mxn.LatLonPoint(37.678, -121.800),
								new mxn.LatLonPoint(37.238, -121.962),
								new mxn.LatLonPoint(37.462, -122.444),
								new mxn.LatLonPoint(37.805, -122.480)
							]);
							break;
					}
					shp.width = 3;
					shp.color = '#00DD55';
					shp.fillColor = '#0077FF';
					shp.opacity = 0.6;
					m.addPolyline(shp);
				}
			},
			{
				desc: 'Remove shape',
				action: function() {
					m.removePolyline(m.polylines[0]);
				}
			},
			{
				desc: 'Add marker',
				action: function(){
					var point;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(51.40995, -0.33627);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -122.0419);
							break;
					}
					var mkr = new mxn.Marker(point);
					mkr.setLabel('Some random place');
					mkr.setInfoBubble('Some information about the random place');
					mkr.click.addHandler(markerEventHandler);
					mkr.openInfoBubble.addHandler(markerEventHandler);
					mkr.closeInfoBubble.addHandler(markerEventHandler);
					m.setCenter(point);
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Show info bubble',
				action: function(){
					m.markers[0].openBubble();
				}
			},
			{
				desc: 'Hide info bubble',
				action: function(){
					m.markers[0].closeBubble();
				}
			},
			{
				desc: 'Add marker offscreen',
				action: function(){
					var marker;
					switch (provider) {
						case 'openspacev4':
							point = new mxn.LatLonPoint(50.54157, -4.93825);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -117.0419);
							break;
					}
					var mkr = new mxn.Marker(point);
					mkr.setLabel('Some other place');
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Auto center',
				action: function(){
					m.autoCenterAndZoom();
				}
			},
			{
				desc: 'Hide one marker',
				action: function(){
					m.markers[0].hide();
				}
			},			
			{
				desc: 'Show one marker',
				action: function(){
					m.markers[0].show();
				}
			},			
			
			{
				desc: 'Add line',
				action: function(){
					var pl;
					switch (provider) {
						case 'openspacev4':
							pl = new mxn.Polyline([
								new mxn.LatLonPoint(51.40995, -0.33627),
								new mxn.LatLonPoint(51.4545, -2.5879),
								new mxn.LatLonPoint(50.72363, -3.53440),
								new mxn.LatLonPoint(50.54157, -4.93825)
							]);
							break;
						default:
							pl = new mxn.Polyline([
								new mxn.LatLonPoint(37.3419, -122.0419),
								new mxn.LatLonPoint(36.3419, -120.0419),
								new mxn.LatLonPoint(38.3419, -119.0419),
								new mxn.LatLonPoint(37.3419, -117.0419)
							]);
							break;
					}
					pl.color = '#00DD55';
					m.addPolyline(pl);
				}
			},
			{
				desc: 'Add 2nd Polyline',
				action: function() {
					var shp;
					switch (provider) {
						case 'openspacev4':
						shp = new mxn.Polyline([
							new mxn.LatLonPoint(51.564, -0.534),
							new mxn.LatLonPoint(51.690, -0.231),
							new mxn.LatLonPoint(51.596, 0.040),
							new mxn.LatLonPoint(51.390, 0.191),
							new mxn.LatLonPoint(51.264, -0.131),
							new mxn.LatLonPoint(51.311, -0.429),
							new mxn.LatLonPoint(51.430, -0.533)
						]);
							break;
						default:
							shp = new mxn.Polyline([
								new mxn.LatLonPoint(37.805, -122.480),
								new mxn.LatLonPoint(37.678, -121.800),
								new mxn.LatLonPoint(37.238, -121.962),
								new mxn.LatLonPoint(37.462, -122.444)
							]);
							break;
					}
					shp.width = 3;
					shp.color = '#0077FF';
					shp.opacity = 0.6;
					m.addPolyline(shp);
				}
			},			
			{
				desc: 'Hide one polyline',
				action: function(){
					m.polylines[0].hide();
				}
			},			
			{
				desc: 'Show one polyline',
				action: function(){
					m.polylines[0].show();
				}
			},
			{
				desc: 'Add All Controls',
				action: function() {
					m.addControls({
						pan:	 true,
						zoom:	 'large',
						overview: true,
						scale: true,
						map_type: true
					});
				}
			},
			{
				desc: 'Remove Controls',
				action: function() {
					m.addControls( { } );
				}
			},
			{
				desc: 'Add Small Controls',
				action: function() {
					m.addSmallControls();
				}
			},
			{
				desc: 'Add Large Controls',
				action: function() {
					m.addControls( { } );
					m.addLargeControls();
				}
			},
			{
				desc: 'Add Pan Controls',
				action: function() {
					m.addControls( { pan: true });
				}
			},
			{
				desc: 'Add Overview Controls',
				action: function() {
					m.addControls( { overview: true });
				}
			},
			{
				desc: 'Add Scale Controls',
				action: function() {
					m.addControls( { scale: true });
				}
			},
			{
				desc: 'Add Map Type Controls',
				action: function() {
					m.addControls( { });
					m.addMapTypeControls();
				}
			},
			/*
			{
				desc: 'Add Base map type',
				action: function() {
					m.addTileLayer("http://tile.openstreetmap.org/{Z}/{X}/{Y}.png", 1.0, "OSM", 1, 19, true);
					// m.setMapType("OSM");
				}
			},
			*/			
			{
				desc: 'Change type',
				action: function(){
					m.setMapType(mxn.Mapstraction.SATELLITE);
				}
			},
			{
				desc: 'Check events',
				action: function() {
					var evt;
					for (evt in events) {
						var props = events[evt];
						var check = true;
						
						if (props.hasOwnProperty('skip')) {
							var skip = props.skip.split(',');
							if (arrayContains(skip, provider)) {
								check = false;
							}
						}
						
						if (check) {
							if (props.value) {
								logInfo('Event: ' + props.name + ' passed');
							}
							else {
								infoElm.style.backgroundColor = '#FCC';
								logInfo('Event: ' + props.name + ' failed');
							}
						}
						
						else {
							logInfo ('Event: ' + props.name + ' skipped');
						}
					}
				}
			},
			
			{
				desc: 'Swap API',
				action: function(){
					if (provider == 'google') {
						m.swap('map', 'here');
					}
					else {
						m.swap('map', 'google');
					}
				}
			},
			
			{
				desc: 'Done.',
				action: function(){
				    if (autoRun === 'true') {

						idx = arrayIndex(supportedProviders, provider);
						if (++idx < supportedProviders.length) {
							var nextProvider = supportedProviders[idx];
							var nextURL =  location.pathname + '?auto=true&provider=' + nextProvider;
							window.location = nextURL;
							return false;
						}
					}
				}
			}
		];
		
		RunTests(ops, actionElm, infoElm);
	
	};
		
	//]]>
	</script>
</head>
<body>
	<h1>Mapstraction Core Test For Provider "<span id="provider"></span>"</h1>
	<div id="wrapper">
		<div id="map"></div>
		<div>
			<h3>Providers</h3>
			<ul id="providers" >
            </ul>
		</div>
		<div id="box-wrapper">
			<div class="box">
				<h2>Actions</h2>
				<div id="container">
					<ol id="actions"></ol>
				</div>
			</div>
			<div class="box">
				<h2>Info</h2>
				<div id="info"></div>
			</div>
			<div class="box">
				<h2>Events</h2>
				<div id="events"></div>
			</div>
		</div>
	</div>
</body>
</html>

