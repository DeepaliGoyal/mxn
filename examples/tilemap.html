<html>
<head>

	<script src="http://code.jquery.com/jquery-1.8.2.min.js" type="text/javascript"></script>
	
	<script type="text/javascript">
	var googlev3_key = 'AIzaSyDW21lnrSsBk4OyHUDmBQ7su9di3yMaO7I';
	var nokia_app_id = 'FbgYuugcrj8Taq6JjmUK';
	var nokia_auth_token = 'Yy2i2n98kaWj69qysOmcYg';
	var microsoftv7_key = 'AlneHdcKOFDot4FjwyuLH8ZSUIz5rv_X22vULKa7H5ia0JnsxiykdO8y-dgLQMU6';
	var provider = 'googlev3';
	var openspace_key = 'CEEFBE51588492CBE0405F0ACA6010B1';
	
	var providerMatch = location.search.match(/provider=([^&]*)/);
	if (providerMatch) {
		provider = providerMatch[1];
	}
	document.writeln('<script type="text/javascript" src="../source/mxn.js?(' + provider + ',[autoload])"><\/script>');
	</script>
	<script type="text/javascript">

	function defaultHandler(name, source, args) {
		console.log(name + ' for ' + args.tileMap.properties.name);
	}

	function assert(map, args) {
	    var pass = 0, fail = 0;
	    //Check map centre - probably need to round this to 3dp or similar
	    if (args.center && map.getCenter() == args.center) { pass += 1 } else { fail += 1; }

	    //Check map zoom
	    if (args.zoom && map.getZoom() == args.zoom) { pass += 1 } else { fail += 1; }

        //Check map type
	    //if (args.map_type && map.getMapType() == args.map_type) { pass += 1 } else { fail += 1; }

        //Check for pan
	    if (args.controls.pan && map.controls.pan == true) { pass += 1 } else { fail += 1; }

	    //Check for zoom
	    if (args.controls.pan && map.controls.zoom == true) { pass += 1 } else { fail += 1; }

	    //Check for overview
	    if (args.controls.overview && map.controls.overview == true) { pass += 1 } else { fail += 1; }

	    //Check for scale
	    if (args.controls.scale && map.controls.scale == true) { pass += 1 } else { fail += 1; }

	    //Check for map_type
	    if (args.controls.map_type && map.controls.map_type == true) { pass += 1 } else { fail += 1; }

	    console.log('Initialise Tests pass ' + pass + ' and fail ' + fail);
	}
	
	$(document).ready(function () {

	    var basemaps = {
	        local: new mxn.TileMap({
	            url: 'http://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png',
	            name: 'local',
	            type: mxn.Mapstraction.TileType.BASE,
	            options: {
					subdomains: 'abc',
	                label: 'Local',
	                alt: 'Local Mapquest Tiles',
	                attribution: 'Tiles &copy; Mapquest',
	                opacity: 1.0,
	                minZoom: 3,
	                maxZoom: 12
	            }
	        })
	    };

	    for (bm in basemaps) {
	        basemaps[bm].tileMapAdded.addHandler(defaultHandler);
	    }

	    var props = {
	        controls: {
	            pan: true,
	            zoom: 'large',
	            overview: 9,
	            scale: true,
	            map_type: true
	        },
	        center: [51.50730, -0.12763],
	        //center: new mxn.LatLonPoint(51.50730, -0.12763),
	        zoom: 10, //Ordnance survey only goes to 10
            enableScrollWheelZoom: true,
	        map_type: mxn.Mapstraction.ROAD //TODO:setting this to local here doesnt work - should it?
	    };
	    var map = new mxn.Mapstraction('map', provider, props);
        
		/*
	    map.addTileMap(basemaps.local, {
	        addControl: true,
	        makeCurrent: true
	    });
	    map.setMapType('local');
        */
		
	    map.load.addHandler(function (sEvtName, oEvtSource, oEvtArgs) {
	        console.log('Map loaded for provider: ' + oEvtSource.api);

	        setTimeout(function () {
	            //console.log(map.getCenter().toString());
	            //assert(map, props);
	            map.setCenter(new mxn.LatLonPoint(51.50730, -0.12763));
	            map.setZoom(12);
	        }, 1000);
	    });

		map.tileMapAdded.addHandler(defaultHandler);
	
		var overlays = {
			toner: new mxn.TileMap({
				url: 'http://tile.stamen.com/toner/{Z}/{X}/{Y}.png',
				name: 'toner',
				type: mxn.Mapstraction.TileType.OVERLAY,
				options: {
					label: 'Toner',
					alt: 'Toner',
					attribution: 'CC-BY-SA © OpenStreetMap contributors',
					opacity: 0.5,
					minZoom: 1,
					maxZoom: 18
				}
			}),
			watercolor: new mxn.TileMap({
				url: 'http://tile.stamen.com/watercolor/{Z}/{X}/{Y}.png',
				name: 'watercolor',
				type: mxn.Mapstraction.TileType.OVERLAY,
				options: {
					label: 'Watercolor',
					alt: 'Watercolor',
					attribution: 'CC-BY-SA © OpenStreetMap contributors',
					opacity: 0.5,
					minZoom: 1,
					maxZoom: 18
				}
			}),
			weather: new mxn.TileMap({
				url: 'http://tile.openweathermap.org/map/pressure_cntr/{z}/{x}/{y}.png',
				name: 'weather',
				type: mxn.Mapstraction.TileType.OVERLAY,
				options: {
					label: 'Weather',
					alt: 'Weather',
					attribution: 'CC-BY-SA © OpenStreetMap contributors',
					opacity: 1.0,
					minZoom: 1,
					maxZoom: 18
				}
			})
		};

		for (om in overlays) {
			overlays[om].tileMapShown.addHandler(defaultHandler);
			overlays[om].tileMapHidden.addHandler(defaultHandler);
		}

		$('#set-road').click(function() {
		    //map.setMapType(mxn.Mapstraction.ROAD);
		    map.removeScaleControls();
		    map.removeLargeControls();
		    map.removePanControls();
		    map.removeMapTypeControls();
		});
		$('#set-satellite').click(function() {
			map.setMapType(mxn.Mapstraction.SATELLITE);
		});
		$('#set-hybrid').click(function() {
			map.setMapType(mxn.Mapstraction.HYBRID);
		});
		$('#set-physical').click(function() {
			map.setMapType(mxn.Mapstraction.PHYSICAL);
		});

		$('#map-osm').click(function() {
			map.addTileMap(basemaps.osm, {
				addControl: true,
				makeCurrent: true
			});
		});
		$('#add-osm').click(function() {
			basemaps.osm.addToMapTypeControl();
		});
		$('#set-osm').click(function() {
			map.setMapType('osm');
		});
		$('#remove-osm').click(function() {
			basemaps.osm.removeFromMapTypeControl();
		});

		$('#map-esri').click(function() {
			map.addTileMap(basemaps.esri, {
				addControl: false,
				makeCurrent: false
			});
		});
		$('#add-esri').click(function() {
			basemaps.esri.addToMapTypeControl();
		});
		$('#set-esri').click(function() {
			map.setMapType('esri');
		});
		$('#remove-esri').click(function() {
			basemaps.esri.removeFromMapTypeControl();
		});

		var acetate;
		$('#map-acetate').click(function() {
			acetate = map.addTileMap('mxn.BaseMapProviders.Acetate.terrain', {
				addControl: false,
				makeCurrent: true
			});
			if (acetate !== null) {
				acetate.tileMapAddedToMapTypeControl.addHandler(defaultHandler);
				acetate.tileMapRemovedFromMapTypeControl.addHandler(defaultHandler);
			}
		})
		$('#add-acetate').click(function() {
			acetate.addToMapTypeControl();
		});
		$('#set-acetate').click(function() {
			map.setMapType('acetate-terrain');
		});
		$('#remove-acetate').click(function() {
			acetate.removeFromMapTypeControl();
		});

		$('#add-toner').click(function() {
			map.addTileMap(overlays.toner);
		});
		$('#show-toner').click(function() {
			overlays.toner.show();
		});
		$('#hide-toner').click(function() {
			overlays.toner.hide();
		});

		$('#add-watercolor').click(function() {
			map.addTileMap(overlays.watercolor);
		});
		$('#show-watercolor').click(function() {
			overlays.watercolor.show();
		});
		$('#hide-watercolor').click(function() {
			overlays.watercolor.hide();
		});

		$('#add-weather').click(function() {
			map.addTileMap(overlays.weather);
		});
		$('#show-weather').click(function() {
			overlays.weather.show();
		});
		$('#hide-weather').click(function() {
			overlays.weather.hide();
		});
	});
	</script>
	<style type="text/css">
	#map {
		width: 100%;
		height: 90%;
		position: relative;
	}
	#nav {
		font: 400 17px/1.3 "Helvetica Neue", sans-serif;
	}
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="nav">
		<strong>Default Base Maps:</strong> <a href="#" id="set-road">Road</a>|<a href="#" id="set-satellite">Satellite</a>|<a href="#" id="set-hybrid">Hybrid</a>|<a href="#" id="set-physical">Physical</a>
		<br />
		<strong>Custom Base Maps:</strong> <em>OSM</em>: <a href="#" id="map-osm">Map</a>|<a href="#" id="add-osm">Add</a>|<a href="#" id="set-osm">Set</a>|<a href="#" id="remove-osm">Remove</a>, <em>Esri</em>: <a href="#" id="map-esri"> Map</a>|<a href="#" id="add-esri">Add</a>|<a href="#" id="set-esri">Set</a>|<a href="#" id="remove-esri">Remove</a>, <em>Acetate</em>: <a href="#" id="map-acetate">Map</a>|<a href="#" id="add-acetate">Add</a>|<a href="#" id="set-acetate">Set</a>|<a href="#" id="remove-acetate">Remove</a>
		<br />
		<strong>Custom Overlays:</strong> <em>Toner</em> : <a href="#" id="add-toner">Add</a>|<a href="#" id="show-toner">Show</a>|<a href="#" id="hide-toner">Hide</a> <em>Watercolor</em> : <a href="#" id="add-watercolor">Add</a>|<a href="#" id="show-watercolor">Show</a>|<a href="#" id="hide-watercolor">Hide</a> <em>Pressure Contours</em> : <a href="#" id="add-weather">Add</a>|<a href="#" id="show-weather">Show</a>|<a href="#" id="hide-weather">Hide</a>
	</div>
</body>
</html>