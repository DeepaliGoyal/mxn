<html>
<head>

    <script src="..\jquery-1.8.2.min.js" type="text/javascript"></script>
	
	<script type="text/javascript">
	var googlev3_key = 'AIzaSyDW21lnrSsBk4OyHUDmBQ7su9di3yMaO7I';
	var nokia_app_id = 'FbgYuugcrj8Taq6JjmUK';
	var nokia_auth_token = 'Yy2i2n98kaWj69qysOmcYg';
	var microsoftv7_key = 'AlneHdcKOFDot4FjwyuLH8ZSUIz5rv_X22vULKa7H5ia0JnsxiykdO8y-dgLQMU6';
	var provider = 'googlev3';
	var openspace_key = 'CEEFBE51588492CBE0405F0ACA6010B1';
	var mapquest_key = 'Fmjtd%7Cluub29uy25%2Crs%3Do5-96zl9y';
	var yandexv1_key = 'AMVH-VABAAAAEdVkcQIAOS-fmBYJfLFV-YDg7ZCPjwVQycUAAAAAAAAAAADwTFcvgPirz7OV75IX_Gsopsw7jA==';
	
	var providerMatch = location.search.match(/provider=([^&]*)/);
	if (providerMatch) {
		provider = providerMatch[1];
	}
	//document.writeln('<script type="text/javascript" src="../source/mxn.js?(' + provider + ',[autoload])"><\/script>');
	var autoload = ',[autoload]'
	document.writeln('<script type="text/javascript" src="../source/mxn.js?(' + provider + autoload +')"><\/script>');
	</script>
	<script type="text/javascript">

	function defaultHandler(name, source, args) {
		console.log(name + ' for ' + args.tileMap.properties.name);
	}

	function makemap() {
	    var debug = true;

	    var props = {
	        controls: {
	            pan: true,
	            zoom: 'small',
	            overview: false,
	            scale: true,
	            map_type: true
	        },
	        center: [51.50730, -0.12763],
	        zoom: 8, //Ordnance survey only goes to 10
	        enableScrollWheelZoom: true,
	        enableDragging: false,
	        enableDoubleClickZoom: true,
	        map_type: mxn.Mapstraction.ROAD
	    };

	    var mapInit = new mxn.Mapstraction('mapInit', provider, props);
	    if (!debug) {
	        var mapSetOptions = new mxn.Mapstraction('mapSetOptions', provider, {
	            center: props.center,
	            zoom: props.zoom
	        });

	        var mapFunctions = new mxn.Mapstraction('mapFunctions', provider, {
	            center: props.center,
	            zoom: props.zoom
	        });

	        mapSetOptions.load.addHandler(function (sEvtName, oEvtSource, oEvtArgs) {
	            console.log('Map loaded for provider: ' + oEvtSource.api);

	            setTimeout(function () {
	                mapSetOptions.setOptions(props);
	            }, 1000);
	        });

	        mapFunctions.load.addHandler(function (sEvtName, oEvtSource, oEvtArgs) {
	            console.log('Map loaded for provider: ' + oEvtSource.api);

	            setTimeout(function () {
	                mapFunctions.enableScrollWheelZoom();
	                mapFunctions.disableDragging();
	                mapFunctions.setMapType(props.map_type);
	                mapFunctions.addScaleControls();
	                mapFunctions.addOverviewControls(props.overview);
	                mapFunctions.addMapTypeControls();
	                mapFunctions.addPanControls();
	                mapFunctions.addSmallControls();
	            }, 1000);
	        });
	    } else {
	        //jquery change class on Initmap to be debugmap

	    }
	    mapInit.load.addHandler(function (sEvtName, oEvtSource, oEvtArgs) {
	        console.log('Map loaded for provider: ' + oEvtSource.api + ' zoom: ' + oEvtSource.getZoom());
	    });

	};

	$(document).ready(function () {
	    if (provider !== 'esri') {
	        makemap();
	    } else {

	        //When the esri map is ready run the setup for the map and the controls
	        require([
            "esri/map",
            "esri/symbols/SimpleMarkerSymbol", "esri/symbols/SimpleLineSymbol", "esri/layers/WebTiledLayer",
            "esri/graphic", "esri/dijit/OverviewMap", "esri/dijit/Scalebar", "esri/dijit/BasemapGallery",
            "dijit/form/Button", "dijit/Menu",
            "dojo/_base/Color", "dojo/dom", "dojo/on", "dojo/dom-construct", "dojo/_base/window", "dojo/dom-style", "dojo/domReady!"
	        ], function () { makemap(); });

	    }
	});

	</script>
	<style type="text/css">
	.map {
		width: 100%;
		height: 33%;
		position: relative;
	}
    .debugmap {
        width: 100%;
        height: 100%;
        position: relative;
    }
	</style>
</head>
<body>
    <div id="mapInit" class="debugmap"></div>
    <div id="mapSetOptions" class="map"></div>
    <div id="mapFunctions" class="map"></div>
</body>
</html>